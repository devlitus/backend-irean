# AI Agents Guide - Irean Backend (Strapi 5)

## üìö Sources of Truth - Complete Instructions

This guide is complemented by:

1. **This file** (`.github/copilot-instructions.md`) - Project conventions, architecture, workflows, database, deployment
2. **[`instructions/strapi-instructions.md`](./instructions/strapi-instructions.md)** - Strapi-specific patterns: controllers, services, routes, schemas, best practices

Consult both files for complete and up-to-date information.

---

## Project Description

This is a backend for an e-commerce web app called Irean, built with Strapi 5 and TypeScript. It provides a REST API to manage products, categories, orders, and users with JWT authentication and user roles. The backend is deployed on Railway and uses SQLite in development and PostgreSQL in production.

## General Architecture

This is a **Strapi 5** backend with TypeScript, deployed on Railway. Key structure:

- **API Layer**: `src/api/` - Content Types organized by entity (e.g., `producto/`)
- **Configuration**: `config/` - Base + `config/env/production/` for environment-specific overrides
- **Types**: `types/generated/` - Auto-generated by Strapi, DO NOT edit manually
- **Data**: SQLite in development (`data/database.sqlite`), PostgreSQL in production

## Project Conventions

### 1. Content Types Structure (Strapi MVC Pattern)

Each Content Type follows this structure in `src/api/{name}/`:

```
product/
‚îú‚îÄ‚îÄ content-types/product/schema.json   # Field definitions and options
‚îú‚îÄ‚îÄ controllers/product.ts              # Endpoint logic (uses factories)
‚îú‚îÄ‚îÄ services/product.ts                 # Reusable business logic
‚îî‚îÄ‚îÄ routes/product.ts                   # REST routes (uses factories)
```

**Critical rule**: Use Strapi's `factories.createCore*()` to generate base code:

```typescript
// ‚ùå DON'T make unnecessary manual implementations
export default factories.createCoreController("api::product.product");
export default factories.createCoreService("api::product.product");
export default factories.createCoreRouter("api::product.product");
```

Only extend factories when you need to customize:

```typescript
export default factories.createCoreController(
  "api::product.product",
  ({ strapi }) => ({
    async customAction(ctx) {
      // Custom logic here
    },
  })
);
```

### 2. Naming Conventions

- **Content Types**: Singular in code (`product`), automatically pluralized in API (`/api/products`)
- **Schema files**: Use `collectionName` for SQL table name (plural): `"collectionName": "products"`
- **TypeScript types**: Auto-generated as `ApiProductProduct` (format: `Api{PascalCase}{PascalCase}`)

### 3. Configuration Pattern

- **Base config**: `config/*.ts` - Uses `env()` helper for environment variables
- **Environment-specific**: `config/env/production/*.ts` - Override for production
- Critical example: `config/env/production/server.ts` has proxy configuration for Railway

### 4. Database Flexibility

`config/database.ts` supports multiple DBs via `DATABASE_CLIENT` env var:

- Development: `sqlite` (default, file at `.tmp/data.db` - configurable via `DATABASE_FILENAME` env var)
- Production Railway: `postgres` (uses `DATABASE_URL` connection string)
- Also supports MySQL configured but not currently used

## Key Workflows

### Local Development

```bash
npm run develop    # Start with hot-reload (port 1337)
npm run build      # Compile admin panel
npm start          # Production without hot-reload
```

### Testing APIs

- Use `.rest` files in `restApi/development/` (VS Code REST Client)
- Development base URL: `http://localhost:1337`
- Endpoints follow pattern: `/api/{plural-name}` (e.g., `/api/productos`)

### Create New Content Type

1. **Recommended option**: Use Strapi Admin UI (`/admin`) - generates everything automatically
2. **Manual** (only if necessary):
   - Create `src/api/{name}/content-types/{name}/schema.json`
   - Factories auto-generate controllers/services/routes
   - Run `npm run develop` to regenerate types in `types/generated/`

### Deploy to Railway

- **Automatic**: Push to `main` or `develop` triggers deploy
- Configuration in `railway.json`:
  - Build: `npm install && npm run build`
  - Start: `npm start`
- Required variables: `APP_KEYS`, `DATABASE_URL`, `ADMIN_JWT_SECRET`, `API_TOKEN_SALT`, `TRANSFER_TOKEN_SALT`, `ENCRYPTION_KEY`

## Integrations and Plugins

### Active Plugins

- `@strapi/plugin-users-permissions`: JWT authentication and roles
- `@strapi/plugin-cloud`: Strapi Cloud integration
- `strapi-health-plugin`: Health check endpoint `/health` for Railway

### Middleware Stack (order matters)

See `config/middlewares.ts` - Strapi standard order:

1. logger ‚Üí errors ‚Üí security ‚Üí cors ‚Üí poweredBy ‚Üí query ‚Üí body ‚Üí session ‚Üí favicon ‚Üí public

## Code-Specific Patterns

### TypeScript Configuration

- **Target**: ES2019, **Module**: CommonJS (required by Strapi)
- **Important exclusions**: `src/admin/` is NOT compiled with the server (has its own tsconfig)
- Strapi auto-regenerates types in `types/generated/` - never edit directly

### Seeding Data

Script in `scripts/seed.js`:

```bash
npm run seed:example  # Import data.json (only on first run)
```

**‚ö†Ô∏è IMPORTANT NOTE**: The current script (`seed.js`) is configured as a generic example. For the actual e-commerce structure (`product`, `category`, `subcategory`, `order`), you would need to:

1. Create data in `data/data.json` with the correct e-commerce structure, OR
2. Adapt `scripts/seed.js` for the project's actual content types

Script features:
- Checks if it has already run using Strapi plugin store
- Creates public permissions automatically for APIs
- Uploads files from `data/uploads/` to storage

### REST API Patterns

Strapi auto-generates:

- `GET /api/products` - List (supports filters, pagination, sort)
- `GET /api/products/:id` - Detail
- `POST /api/products` - Create
- `PUT /api/products/:id` - Update
- `DELETE /api/products/:id` - Delete

Global configuration in `config/api.ts`:

```typescript
defaultLimit: 25, maxLimit: 100, withCount: true
```

## Common Troubleshooting

1. **Outdated types**: Run `npm run develop` to regenerate `types/generated/`
2. **DB locked (SQLite)**: Only one process can access - close other instances
3. **Railway deployment fails**: Verify all env vars are set (especially `APP_KEYS`)
4. **CORS errors**: Configure `config/middlewares.ts` or environment-specific config

## Quick References

- **Strapi Docs**: https://docs.strapi.io/dev-docs/intro
- **API Reference**: https://docs.strapi.io/dev-docs/api/rest
- **TypeScript Guide**: https://docs.strapi.io/dev-docs/typescript
- **Deployment Railway**: https://docs.strapi.io/dev-docs/deployment/railway

## Modification Rules

When modifying or creating code:

1. **Respect factories** - Don't reimplement what Strapi provides
2. **Schemas first** - Define `schema.json` before controllers
3. **Types read-only** - Let Strapi regenerate them
4. **Environment-aware** - Consider dev vs production (DB, URLs, proxy)
5. **Naming consistency** - Singular in code, Strapi handles pluralization
